name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify Google Sheets URL secret
        run: |
          if [ -z "${{ secrets.VITE_GOOGLE_SHEETS_URL }}" ]; then
            echo "::error::VITE_GOOGLE_SHEETS_URL secret is not set!"
            echo "Please add it in Settings ‚Üí Secrets and variables ‚Üí Actions"
            exit 1
          else
            echo "‚úÖ VITE_GOOGLE_SHEETS_URL secret is configured"
            # Show first 50 chars and last 10 chars for verification (without exposing full URL)
            SECRET_VALUE="${{ secrets.VITE_GOOGLE_SHEETS_URL }}"
            PREFIX=$(echo "$SECRET_VALUE" | cut -c1-50)
            SUFFIX=$(echo "$SECRET_VALUE" | rev | cut -c1-10 | rev)
            echo "   URL starts with: $PREFIX..."
            echo "   URL ends with: ...$SUFFIX"
            echo "   URL length: ${#SECRET_VALUE} characters"
            # Verify it ends with /exec
            if [[ "$SECRET_VALUE" == */exec ]]; then
              echo "‚úÖ URL format looks correct (ends with /exec)"
            else
              echo "‚ö†Ô∏è  Warning: URL should end with /exec"
            fi
          fi

      - name: Set base path
        id: base
        run: |
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          echo "Repository: ${{ github.repository }}"
          echo "Repository name: $REPO_NAME"
          if [[ "$REPO_NAME" == *".github.io" ]]; then
            BASE_PATH="/"
            echo "Using base path: $BASE_PATH (user/organization page)"
          else
            BASE_PATH="/$REPO_NAME/"
            echo "Using base path: $BASE_PATH (project page)"
          fi
          echo "base=$BASE_PATH" >> $GITHUB_OUTPUT
          echo "::notice::Base path set to: $BASE_PATH"

      - name: Build
        run: |
          echo "üî® Building application..."
          echo "   VITE_BASE: ${{ steps.base.outputs.base }}"
          echo "   VITE_GOOGLE_SHEETS_URL: [REDACTED - checking if set...]"
          if [ -z "${{ secrets.VITE_GOOGLE_SHEETS_URL }}" ]; then
            echo "   ‚ö†Ô∏è  WARNING: VITE_GOOGLE_SHEETS_URL is not set!"
          else
            echo "   ‚úÖ VITE_GOOGLE_SHEETS_URL is set"
          fi
          npm run build
        env:
          VITE_BASE: ${{ steps.base.outputs.base }}
          VITE_GOOGLE_SHEETS_URL: ${{ secrets.VITE_GOOGLE_SHEETS_URL }}
        
      - name: Verify build output
        run: |
          echo "üîç Checking build output..."
          if [ -f dist/index.html ]; then
            echo "‚úÖ index.html exists"
            echo ""
            echo "Checking for base path in built files..."
            grep -o 'src="[^"]*"' dist/index.html | head -3 || echo "No src attributes found"
            echo ""
            echo "Checking if Google Sheets URL is embedded..."
            # Check JavaScript files for the URL (Vite embeds env vars)
            if grep -r "script.google.com" dist/assets/ 2>/dev/null | head -1; then
              echo "‚úÖ Google Sheets URL found in built files"
            else
              echo "‚ö†Ô∏è  Warning: Google Sheets URL not found in built files"
              echo "   This might mean the env var wasn't embedded during build"
            fi
          else
            echo "‚ùå ERROR: dist/index.html not found!"
            exit 1
          fi

      - name: Test Google Sheets connection
        run: |
          echo "üß™ Testing Google Sheets connection..."
          echo ""
          
          GOOGLE_SHEETS_URL="${{ secrets.VITE_GOOGLE_SHEETS_URL }}"
          
          if [ -z "$GOOGLE_SHEETS_URL" ]; then
            echo "‚ùå Cannot test: VITE_GOOGLE_SHEETS_URL secret is not set"
            exit 1
          fi
          
          echo "üì§ Sending test request to Google Sheets..."
          echo "   URL: ${GOOGLE_SHEETS_URL:0:50}..."
          echo ""
          
          TEST_DATA='{"name":"GitHub Actions Test","responseType":"yes","selectedOption":"Automated deployment test"}'
          
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            -H "Content-Type: application/json" \
            -d "$TEST_DATA" \
            "$GOOGLE_SHEETS_URL" 2>&1) || true
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')
          
          echo "üì• Response:"
          echo "   HTTP Status: ${HTTP_STATUS:-'No status code'}"
          echo "   Body: $BODY"
          echo ""
          
          if [ "$HTTP_STATUS" = "200" ] || [ -z "$HTTP_STATUS" ]; then
            echo "‚úÖ Test request completed (status: ${HTTP_STATUS:-'unknown'})"
            echo "üí° Note: Google Apps Script may return different status codes"
            echo "   Check your Google Sheet to verify the test entry was added"
          else
            echo "‚ö†Ô∏è  Warning: Unexpected status code: $HTTP_STATUS"
            echo "   This might still work - Google Apps Script can return various codes"
          fi
          
          echo ""
          echo "‚úÖ Connection test completed"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

